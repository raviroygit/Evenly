# Fix for Expense Creation API Failure

## Problem Summary
The API was failing when adding expenses in groups with error:
```
DatabaseError: Failed to update user balances
```

## Root Causes Identified

1. **Hidden Error Details**: The catch block in `updateUserBalances()` was masking the actual database error
2. **Missing Unique Constraint**: No unique constraint on `(userId, groupId)` in the `user_balances` table, potentially allowing duplicate records
3. **Race Condition**: Check-then-insert pattern had a race condition for concurrent requests

## Changes Made

### 1. Enhanced Error Logging (`src/services/expenseService.ts`)
- Added detailed error logging in `updateUserBalances()` catch block
- Now logs error name, message, stack trace, and PostgreSQL error codes/details
- This will help identify the actual database error in future failures

### 2. Schema Update (`src/db/schema.ts`)
- Added unique constraint: `user_balances_user_group_unique` on `(user_id, group_id)`
- Prevents duplicate balance records for the same user in the same group
- Generates clearer errors if duplicate insertion is attempted

### 3. Migration Files Created
- `migrations/0000_bumpy_zaladane.sql` - Full schema with unique constraint (auto-generated by Drizzle)
- `src/migrations/003_add_user_balance_unique_constraint.sql` - SQL migration for manual application
- `scripts/migrate-user-balance-constraint.ts` - Safe migration script that:
  - Checks if constraint already exists
  - Identifies and removes duplicate records (keeps most recent)
  - Adds the unique constraint

## Deployment Steps

### Option 1: Automated Deployment (Recommended)

```bash
# 1. Build the project
npm run build

# 2. Run the migration script on production database
npx tsx scripts/migrate-user-balance-constraint.ts

# 3. Deploy to Cloud Run
npm run deploy
```

### Option 2: Manual Database Migration + Deploy

```bash
# 1. Connect to production database and run:
psql $EVENLY_DATABASE_URL < src/migrations/003_add_user_balance_unique_constraint.sql

# 2. Build and deploy
npm run build
npm run deploy
```

### Option 3: Deploy Without Migration (Risky)

```bash
# Just deploy the code changes
npm run build
npm run deploy

# The improved error logging will help identify the issue
# Then run the migration separately after seeing the actual error
```

## Verification Steps

1. **Check Cloud Run Logs**:
   ```bash
   gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=evenly-backend AND severity>=ERROR" --limit=20 --project=nextgen-ai-dev
   ```

2. **Test Expense Creation**:
   - Try creating an expense in a group via the mobile app
   - Check for detailed error logs if it still fails
   - The new logging will show the actual PostgreSQL error

3. **Verify Constraint**:
   ```sql
   SELECT constraint_name, constraint_type
   FROM information_schema.table_constraints
   WHERE table_name = 'user_balances';
   ```

## Rollback Plan

If the deployment causes issues:

1. **Remove the constraint** (if it's causing problems):
   ```sql
   ALTER TABLE user_balances DROP CONSTRAINT IF EXISTS user_balances_user_group_unique;
   ```

2. **Redeploy previous version**:
   ```bash
   git checkout HEAD~1
   npm run build
   npm run deploy
   ```

## Expected Outcomes

After deployment:
- ✅ Expense creation should work without errors
- ✅ No duplicate balance records will be created
- ✅ If errors still occur, logs will show the actual database error details
- ✅ Database integrity is improved with the unique constraint

## Monitoring

Monitor the following after deployment:
1. Error rate for POST `/api/expenses` endpoint
2. Cloud Run logs for any new error patterns
3. User balance consistency across groups

## Notes

- The migration script is idempotent (can be run multiple times safely)
- Duplicate records (if any) will be merged, keeping the most recent balance
- The constraint will prevent future race conditions in balance updates
